services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezami-api-server
    image: ezami-api:latest
    ports:
      - "8090:8080"
    environment:
      SERVER_PORT: "8080"

      # Database - kết nối tới MySQL của ezami-web
      DB_DRIVER: "com.mysql.cj.jdbc.Driver"
      DB_URL: "jdbc:mysql://ezami-mysql:3306/wordpress?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Ho_Chi_Minh&useUnicode=true&characterEncoding=UTF-8"
      DB_USER: "root"
      DB_PASS: "12345678aA@"

      # Redis - kết nối tới Redis của ezami-web (không có password)
      SPRING_REDIS_HOST: "ezami-redis"
      SPRING_REDIS_PORT: "6379"
      SPRING_REDIS_PASSWORD: ""

      # JWT & cấu hình khác
      JWT_SECRET: "your-secret-key-change-in-production"
      JWT_COOKIE_NAME: accessToken
      JWT_COOKIE_MAX_AGE: 604800
      JWT_COOKIE_SECURE: "false"
      JWT_COOKIE_HTTP_ONLY: "true"
      JWT_COOKIE_SAME_SITE: Lax

      GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID:-}"
      GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET:-}"
      GOOGLE_REDIRECT_URI: "${GOOGLE_REDIRECT_URI:-https://api-v2.ezami.io/auth/google/callback}"
      GOOGLE_REDIRECT_MOBILE_SUCCESS_URL: "${GOOGLE_REDIRECT_MOBILE_SUCCESS_URL:-ezami://auth/success}"
      GOOGLE_REDIRECT_WEB_SUCCESS_URL: "${GOOGLE_REDIRECT_WEB_SUCCESS_URL:-https://ezami.io/api/proxy/auth/google/callback}"

      REVENUECAT_API_BASE_URL: "${REVENUECAT_API_BASE_URL:-}"
      REVENUECAT_SECRET_API_KEY: "${REVENUECAT_SECRET_API_KEY:-}"
      REVENUECAT_WEBHOOK_SECRET: "${REVENUECAT_WEBHOOK_SECRET:-}"
      REVENUECAT_SUBSCRIBERS_ENDPOINT: "${REVENUECAT_SUBSCRIBERS_ENDPOINT:-}"

      MAIL_HOST: "${MAIL_HOST:-smtp.gmail.com}"
      MAIL_PORT: "${MAIL_PORT:-587}"
      MAIL_USERNAME: "${MAIL_USERNAME:-}"
      MAIL_PASSWORD: "${MAIL_PASSWORD:-}"
      MAIL_FROM: "${MAIL_FROM:-noreply@ezami.io}"
      MAIL_FROM_NAME: "${MAIL_FROM_NAME:-Ezami}"

      # Affiliate & other configs
      AFFILIATE_BASE_URL: "${AFFILIATE_BASE_URL:-https://ezami.io}"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - ezami_ezami-network

# Sử dụng network từ ezami (project name)
networks:
  ezami_ezami-network:
    external: true
